{"version":3,"sources":["../../src/auth/passport-auth.controller.ts"],"sourcesContent":["import {\n  Body,\n  Controller,\n  Get,\n  HttpCode,\n  HttpStatus,\n  Post,\n  UseGuards,\n  Request,\n  Response,\n} from '@nestjs/common';\nimport { ApiTags, ApiOperation, ApiResponse, ApiBody } from '@nestjs/swagger';\nimport { AuthService } from './auth.service';\nimport { PassportJwtAuthGuard } from './guards/passport-jwt.guard';\nimport { PassportLocalGuard } from './guards/passport-local.guard';\n\n@ApiTags('auth')\n@Controller('auth')\nexport class PassportAuthController {\n  constructor(private authService: AuthService) {}\n\n  @ApiOperation({ summary: 'Login with email and password' })\n  @ApiBody({\n    schema: {\n      type: 'object',\n      properties: {\n        email: { type: 'string', example: 'teacher@example.com' },\n        password: { type: 'string', example: 'password123' },\n      },\n    },\n  })\n  @ApiResponse({\n    status: 200,\n    description:\n      'Login successful. Returns user data and sets access token cookie.',\n  })\n  @ApiResponse({\n    status: 401,\n    description: 'Unauthorized. Invalid credentials.',\n  })\n  @HttpCode(HttpStatus.OK)\n  @Post('login')\n  @UseGuards(PassportLocalGuard)\n  async login(@Request() request, @Response({ passthrough: true }) response) {\n    const token = await this.authService.getToken(request.user);\n\n    response.cookie('access_token', token, {\n      httpOnly: true,\n      secure: process.env.NODE_ENV === 'production',\n      sameSite: 'lax',\n      maxAge: 24 * 60 * 60 * 1000, // 24 hours\n    });\n\n    return {\n      user: {\n        id: request.user.id.toString(),\n        email: request.user.email,\n        name: request.user.name,\n        roles: request.user.roles ?? [],\n        teacherId: request.user.teacherId ?? null,\n        studentId: request.user.studentId ?? null,\n      },\n    };\n  }\n\n  @ApiOperation({ summary: 'Logout current user' })\n  @ApiResponse({\n    status: 200,\n    description: 'Logout successful. Clears access token cookie.',\n  })\n  @Post('logout')\n  @HttpCode(HttpStatus.OK)\n  logout(@Response({ passthrough: true }) response) {\n    response.clearCookie('access_token');\n    return { message: 'Logged out successfully' };\n  }\n\n  @ApiOperation({ summary: 'Get current user profile' })\n  @ApiResponse({ status: 200, description: 'Returns current user profile.' })\n  @ApiResponse({\n    status: 401,\n    description: 'Unauthorized. Valid JWT token required.',\n  })\n  @Get('profile')\n  @UseGuards(PassportJwtAuthGuard)\n  getProfile(@Request() request) {\n    return {\n      user: {\n        id: request.user.id.toString(),\n        email: request.user.email,\n        name: request.user.name,\n        roles: request.user.roles ?? [],\n        teacherId: request.user.teacherId ?? null,\n        studentId: request.user.studentId ?? null,\n      },\n    };\n  }\n\n  @ApiOperation({ summary: 'Backfill Users from Teachers (dev only)' })\n  @ApiResponse({ status: 200, description: 'Backfill executed' })\n  @Post('backfill-teachers')\n  async backfillTeachers() {\n    return this.authService.backfillUsersFromTeachers();\n  }\n\n  @ApiOperation({ summary: 'Reset user password by email' })\n  @ApiBody({\n    schema: {\n      type: 'object',\n      properties: {\n        email: { type: 'string', example: 'teacher@example.com' },\n        newPassword: { type: 'string', example: 'newpassword123' },\n      },\n    },\n  })\n  @ApiResponse({ status: 200, description: 'Password reset successful' })\n  @ApiResponse({ status: 404, description: 'User not found' })\n  @Post('reset-password')\n  async resetPassword(@Body() body: { email: string; newPassword: string }) {\n    return this.authService.resetPassword(body.email, body.newPassword);\n  }\n}\n"],"names":["PassportAuthController","login","request","response","token","authService","getToken","user","cookie","httpOnly","secure","process","env","NODE_ENV","sameSite","maxAge","id","toString","email","name","roles","teacherId","studentId","logout","clearCookie","message","getProfile","backfillTeachers","backfillUsersFromTeachers","resetPassword","body","newPassword","summary","schema","type","properties","example","password","status","description","OK","passthrough"],"mappings":";;;;+BAkBaA;;;eAAAA;;;wBARN;yBACqD;6BAChC;kCACS;oCACF;;;;;;;;;;;;;;;AAI5B,IAAA,AAAMA,yBAAN,MAAMA;IAGX,MAsBMC,MAAM,AAAWC,OAAO,EAAE,AAAiCC,QAAQ,EAAE;QACzE,MAAMC,QAAQ,MAAM,IAAI,CAACC,WAAW,CAACC,QAAQ,CAACJ,QAAQK,IAAI;QAE1DJ,SAASK,MAAM,CAAC,gBAAgBJ,OAAO;YACrCK,UAAU;YACVC,QAAQC,QAAQC,GAAG,CAACC,QAAQ,KAAK;YACjCC,UAAU;YACVC,QAAQ,KAAK,KAAK,KAAK;QACzB;QAEA,OAAO;YACLR,MAAM;gBACJS,IAAId,QAAQK,IAAI,CAACS,EAAE,CAACC,QAAQ;gBAC5BC,OAAOhB,QAAQK,IAAI,CAACW,KAAK;gBACzBC,MAAMjB,QAAQK,IAAI,CAACY,IAAI;gBACvBC,OAAOlB,QAAQK,IAAI,CAACa,KAAK,IAAI,EAAE;gBAC/BC,WAAWnB,QAAQK,IAAI,CAACc,SAAS,IAAI;gBACrCC,WAAWpB,QAAQK,IAAI,CAACe,SAAS,IAAI;YACvC;QACF;IACF;IASAC,OAAO,AAAiCpB,QAAQ,EAAE;QAChDA,SAASqB,WAAW,CAAC;QACrB,OAAO;YAAEC,SAAS;QAA0B;IAC9C;IAUAC,WAAW,AAAWxB,OAAO,EAAE;QAC7B,OAAO;YACLK,MAAM;gBACJS,IAAId,QAAQK,IAAI,CAACS,EAAE,CAACC,QAAQ;gBAC5BC,OAAOhB,QAAQK,IAAI,CAACW,KAAK;gBACzBC,MAAMjB,QAAQK,IAAI,CAACY,IAAI;gBACvBC,OAAOlB,QAAQK,IAAI,CAACa,KAAK,IAAI,EAAE;gBAC/BC,WAAWnB,QAAQK,IAAI,CAACc,SAAS,IAAI;gBACrCC,WAAWpB,QAAQK,IAAI,CAACe,SAAS,IAAI;YACvC;QACF;IACF;IAEA,MAGMK,mBAAmB;QACvB,OAAO,IAAI,CAACtB,WAAW,CAACuB,yBAAyB;IACnD;IAEA,MAaMC,cAAc,AAAQC,IAA4C,EAAE;QACxE,OAAO,IAAI,CAACzB,WAAW,CAACwB,aAAa,CAACC,KAAKZ,KAAK,EAAEY,KAAKC,WAAW;IACpE;IArGA,YAAY,AAAQ1B,WAAwB,CAAE;aAA1BA,cAAAA;IAA2B;AAsGjD;;;QApGkB2B,SAAS;;;QAEvBC,QAAQ;YACNC,MAAM;YACNC,YAAY;gBACVjB,OAAO;oBAAEgB,MAAM;oBAAUE,SAAS;gBAAsB;gBACxDC,UAAU;oBAAEH,MAAM;oBAAUE,SAAS;gBAAc;YACrD;QACF;;;QAGAE,QAAQ;QACRC,aACE;;;QAGFD,QAAQ;QACRC,aAAa;;6CAEMC;;;;;QAGuBC,aAAa;;;;;;;;;;;QAsBzCT,SAAS;;;QAEvBM,QAAQ;QACRC,aAAa;;;6CAGMC;;QACFC,aAAa;;;;;;;;;;QAKhBT,SAAS;;;QACVM,QAAQ;QAAKC,aAAa;;;QAEvCD,QAAQ;QACRC,aAAa;;;;;;;;;;;;;QAiBCP,SAAS;;;QACVM,QAAQ;QAAKC,aAAa;;;;;;;;;QAMzBP,SAAS;;;QAEvBC,QAAQ;YACNC,MAAM;YACNC,YAAY;gBACVjB,OAAO;oBAAEgB,MAAM;oBAAUE,SAAS;gBAAsB;gBACxDL,aAAa;oBAAEG,MAAM;oBAAUE,SAAS;gBAAiB;YAC3D;QACF;;;QAEaE,QAAQ;QAAKC,aAAa;;;QAC1BD,QAAQ;QAAKC,aAAa"}