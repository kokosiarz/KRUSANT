{"version":3,"sources":["../../src/classes/classes.service.ts"],"sourcesContent":["import { Injectable, Inject, forwardRef } from '@nestjs/common';\nimport { InjectRepository } from '@nestjs/typeorm';\nimport { Repository } from 'typeorm';\nimport { ClassEntity } from './class.entity';\nimport { CreateClassDto } from './dto/create-class.dto';\nimport { UpdateClassDto } from './dto/update-class.dto';\nimport { Student } from '../students/student.entity';\nimport { DebitsService } from '../debits/debits.service';\nimport { GroupsService } from '../groups/groups.service';\n\n@Injectable()\nexport class ClassesService {\n  constructor(\n    @InjectRepository(ClassEntity)\n    private classRepository: Repository<ClassEntity>,\n    private debitsService: DebitsService,\n    @Inject(forwardRef(() => GroupsService))\n    private groupsService: GroupsService,\n  ) {}\n\n  async findAll(groupId?: number): Promise<ClassEntity[]> {\n    if (groupId !== undefined) {\n      return await this.classRepository.find({ where: { groupId } });\n    }\n    return await this.classRepository.find();\n  }\n\n  async findOne(id: number): Promise<ClassEntity> {\n    return await this.classRepository.findOne({ where: { id } });\n  }\n\n  async create(createDto: CreateClassDto): Promise<ClassEntity> {\n    const {\n      attendedStudentsIds,\n      plannedStudentsIds,\n      teacherId,\n      cost,\n      comment,\n      ...rest\n    } = createDto;\n    const entity = this.classRepository.create({ ...rest, cost, comment });\n    if (attendedStudentsIds) {\n      (entity as any).attendedStudentsIds = attendedStudentsIds;\n    }\n    if (plannedStudentsIds) {\n      (entity as any).plannedStudentsIds = plannedStudentsIds;\n    }\n    if (teacherId !== undefined) {\n      (entity as any).teacherId = teacherId;\n    }\n    if (cost !== undefined) {\n      (entity as any).cost = cost;\n    }\n    if (comment !== undefined) {\n      (entity as any).comment = comment;\n    }\n    return await this.classRepository.save(entity);\n  }\n\n  async update(id: number, updateDto: UpdateClassDto): Promise<ClassEntity> {\n    await this.classRepository.update(id, updateDto);\n    return await this.findOne(id);\n  }\n\n  async setAttendance(\n    id: number,\n    attendedStudentsIds: number[],\n  ): Promise<{ class: ClassEntity; createdDebits: any[] }> {\n    const classEntity = await this.classRepository.findOne({ where: { id } });\n    if (!classEntity) throw new Error('Class not found');\n    classEntity.attendedStudentsIds = Array.isArray(attendedStudentsIds)\n      ? attendedStudentsIds\n          .map(Number)\n          .filter((v) => typeof v === 'number' && !isNaN(v))\n      : [];\n    await this.classRepository.save(classEntity);\n\n    // Prepare group name for entitlement\n    let groupName = 'kurs';\n    if (classEntity.groupId) {\n      const group = await this.groupsService.findOne(classEntity.groupId);\n      if (group && group.name) groupName = group.name;\n    }\n\n    const createdDebits = [];\n    for (const studentId of attendedStudentsIds) {\n      // Check if a debit exists for this student and class\n      const existing = await this.debitsService.findAll();\n      const alreadyExists = existing.some(\n        (d) => d.studentId === studentId && d.classId === classEntity.id,\n      );\n      if (!alreadyExists) {\n        // Fetch student to get discount\n        const studentRepo = this.classRepository.manager.getRepository('Student');\n        const student = await studentRepo.findOne({ where: { id: studentId } });\n        let amount = classEntity.cost;\n        if (\n          student &&\n          typeof student.discount === 'number' &&\n          !isNaN(student.discount)\n        ) {\n          amount =\n            (Number(classEntity.cost) * (100 - Number(student.discount))) / 100;\n        }\n        const debit = await this.debitsService.create({\n          studentId,\n          classId: classEntity.id,\n          amount,\n          dueDate: classEntity.startTime\n            ? new Date(classEntity.startTime)\n            : new Date(),\n          entitlement: `${groupName} @ ${new Date(classEntity.startTime).toLocaleString('pl-PL')}`,\n        });\n        createdDebits.push(debit);\n      }\n    }\n\n    return { class: classEntity, createdDebits };\n  }\n\n  async remove(id: number): Promise<void> {\n    await this.classRepository.delete(id);\n  }\n\n  async batchUpsert(\n    classes: CreateClassDto[],\n  ): Promise<{ created: number; updated: number; classes: ClassEntity[] }> {\n    const results: ClassEntity[] = [];\n    let created = 0;\n    let updated = 0;\n\n    for (const classDto of classes) {\n      // Find existing class by startTime and roomId\n      const existingClass = await this.classRepository.findOne({\n        where: { startTime: classDto.startTime, roomId: classDto.roomId },\n      });\n\n      if (existingClass) {\n        // Update existing class\n        await this.classRepository.update(existingClass.id, classDto);\n        const updatedClass = await this.findOne(existingClass.id);\n        results.push(updatedClass);\n        updated++;\n      } else {\n        // Create new class\n        const newClass = this.classRepository.create(classDto);\n        const savedClass = await this.classRepository.save(newClass);\n        results.push(savedClass);\n        created++;\n      }\n    }\n    return { created, updated, classes: results };\n  }\n\n  async batchCreate(classes: CreateClassDto[]): Promise<ClassEntity[]> {\n    const created: ClassEntity[] = [];\n    for (const classDto of classes) {\n      const newClass = this.classRepository.create(classDto);\n      const savedClass = await this.classRepository.save(newClass);\n      created.push(savedClass);\n    }\n    return created;\n  }\n}\n"],"names":["ClassesService","findAll","groupId","undefined","classRepository","find","where","findOne","id","create","createDto","attendedStudentsIds","plannedStudentsIds","teacherId","cost","comment","rest","entity","save","update","updateDto","setAttendance","classEntity","Error","Array","isArray","map","Number","filter","v","isNaN","groupName","group","groupsService","name","createdDebits","studentId","existing","debitsService","alreadyExists","some","d","classId","studentRepo","manager","getRepository","student","amount","discount","debit","dueDate","startTime","Date","entitlement","toLocaleString","push","class","remove","delete","batchUpsert","classes","results","created","updated","classDto","existingClass","roomId","updatedClass","newClass","savedClass","batchCreate","GroupsService"],"mappings":"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"}