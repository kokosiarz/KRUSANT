{"version":3,"sources":["../../src/auth/auth.service.ts"],"sourcesContent":["import {\n  Injectable,\n  UnauthorizedException,\n  ForbiddenException,\n  NotFoundException,\n} from '@nestjs/common';\nimport { TeachersService } from 'src/teachers/teachers.service';\nimport { JwtService } from '@nestjs/jwt';\nimport { UsersService } from 'src/users/users.service';\nimport { Role } from './roles.enum';\n\ntype AuthInput = { email: string; password: string };\ntype SignInData = { \n  id: number; \n  email: string; \n  name: string; \n  roles: string[];\n  teacherId?: number | null;\n  studentId?: number | null;\n};\ntype AuthOutput = {\n  user: {\n    id: string;\n    email: string;\n    name: string;\n  };\n  token: string;\n};\n\n@Injectable()\nexport class AuthService {\n  constructor(\n    private teachersService: TeachersService,\n    private usersService: UsersService,\n    private jwtService: JwtService,\n  ) {}\n\n  async authenticate(input: AuthInput): Promise<AuthOutput | null> {\n    // Placeholder logic for authentication\n    const signIn = await this.validate(input);\n    if (!signIn) {\n      throw new UnauthorizedException();\n    }\n    const accessToken = await this.getToken(signIn);\n    return {\n      user: {\n        id: signIn.id.toString(),\n        email: signIn.email,\n        name: signIn.name,\n      },\n      token: accessToken,\n    };\n  }\n\n  async validate(input: AuthInput): Promise<SignInData | null> {\n    const user = await this.usersService.findByEmail(input.email);\n    if (!user) return null;\n    const ok = await this.usersService.verifyPassword(user, input.password);\n    if (!ok) return null;\n\n    // Derive name: prefer teacher profile name if linked, else email\n    let name = user.email;\n    if (user.teacherId) {\n      const teacher = await this.teachersService.findOneById(user.teacherId);\n      if (teacher?.name) name = teacher.name;\n    }\n    return { \n      id: user.id, \n      email: user.email, \n      name, \n      roles: user.roles ?? [],\n      teacherId: user.teacherId ?? null,\n      studentId: user.studentId ?? null,\n    };\n  }\n\n  async getToken(data: SignInData): Promise<string> {\n    const payload = {\n      sub: data.id,\n      email: data.email,\n      name: data.name,\n      roles: data.roles,\n      teacherId: data.teacherId,\n      studentId: data.studentId,\n    };\n    const accessToken = await this.jwtService.signAsync(payload);\n    return accessToken;\n  }\n\n  async resetPassword(\n    email: string,\n    newPassword: string,\n  ): Promise<{ message: string }> {\n    const user = await this.usersService.findByEmail(email);\n    if (!user) {\n      throw new NotFoundException('User not found');\n    }\n    await this.usersService.setPassword(user.id, newPassword);\n    return { message: 'Password reset successfully' };\n  }\n\n  // One-time backfill: create Users for Teachers not yet linked\n  async backfillUsersFromTeachers(): Promise<{ created: number }> {\n    if (process.env.ALLOW_BACKFILL !== 'true') {\n      throw new ForbiddenException('Backfill disabled');\n    }\n    const teachers = await this.teachersService.findAll();\n    let created = 0;\n    for (const t of teachers) {\n      if (!t.email) continue;\n      const existing = await this.usersService.findByEmail(t.email);\n      if (existing) continue;\n      await this.usersService.create({\n        email: t.email,\n        roles: [Role.Teacher],\n        teacherId: t.id,\n      });\n      created++;\n    }\n    return { created };\n  }\n}\n"],"names":["AuthService","authenticate","input","signIn","validate","UnauthorizedException","accessToken","getToken","user","id","toString","email","name","token","usersService","findByEmail","ok","verifyPassword","password","teacherId","teacher","teachersService","findOneById","roles","studentId","data","payload","sub","jwtService","signAsync","resetPassword","newPassword","NotFoundException","setPassword","message","backfillUsersFromTeachers","process","env","ALLOW_BACKFILL","ForbiddenException","teachers","findAll","created","t","existing","create","Role","Teacher"],"mappings":";;;;+BA8BaA;;;eAAAA;;;wBAzBN;iCACyB;qBACL;8BACE;2BACR;;;;;;;;;;AAqBd,IAAA,AAAMA,cAAN,MAAMA;IAOX,MAAMC,aAAaC,KAAgB,EAA8B;QAC/D,uCAAuC;QACvC,MAAMC,SAAS,MAAM,IAAI,CAACC,QAAQ,CAACF;QACnC,IAAI,CAACC,QAAQ;YACX,MAAM,IAAIE,6BAAqB;QACjC;QACA,MAAMC,cAAc,MAAM,IAAI,CAACC,QAAQ,CAACJ;QACxC,OAAO;YACLK,MAAM;gBACJC,IAAIN,OAAOM,EAAE,CAACC,QAAQ;gBACtBC,OAAOR,OAAOQ,KAAK;gBACnBC,MAAMT,OAAOS,IAAI;YACnB;YACAC,OAAOP;QACT;IACF;IAEA,MAAMF,SAASF,KAAgB,EAA8B;QAC3D,MAAMM,OAAO,MAAM,IAAI,CAACM,YAAY,CAACC,WAAW,CAACb,MAAMS,KAAK;QAC5D,IAAI,CAACH,MAAM,OAAO;QAClB,MAAMQ,KAAK,MAAM,IAAI,CAACF,YAAY,CAACG,cAAc,CAACT,MAAMN,MAAMgB,QAAQ;QACtE,IAAI,CAACF,IAAI,OAAO;QAEhB,iEAAiE;QACjE,IAAIJ,OAAOJ,KAAKG,KAAK;QACrB,IAAIH,KAAKW,SAAS,EAAE;YAClB,MAAMC,UAAU,MAAM,IAAI,CAACC,eAAe,CAACC,WAAW,CAACd,KAAKW,SAAS;YACrE,IAAIC,SAASR,MAAMA,OAAOQ,QAAQR,IAAI;QACxC;QACA,OAAO;YACLH,IAAID,KAAKC,EAAE;YACXE,OAAOH,KAAKG,KAAK;YACjBC;YACAW,OAAOf,KAAKe,KAAK,IAAI,EAAE;YACvBJ,WAAWX,KAAKW,SAAS,IAAI;YAC7BK,WAAWhB,KAAKgB,SAAS,IAAI;QAC/B;IACF;IAEA,MAAMjB,SAASkB,IAAgB,EAAmB;QAChD,MAAMC,UAAU;YACdC,KAAKF,KAAKhB,EAAE;YACZE,OAAOc,KAAKd,KAAK;YACjBC,MAAMa,KAAKb,IAAI;YACfW,OAAOE,KAAKF,KAAK;YACjBJ,WAAWM,KAAKN,SAAS;YACzBK,WAAWC,KAAKD,SAAS;QAC3B;QACA,MAAMlB,cAAc,MAAM,IAAI,CAACsB,UAAU,CAACC,SAAS,CAACH;QACpD,OAAOpB;IACT;IAEA,MAAMwB,cACJnB,KAAa,EACboB,WAAmB,EACW;QAC9B,MAAMvB,OAAO,MAAM,IAAI,CAACM,YAAY,CAACC,WAAW,CAACJ;QACjD,IAAI,CAACH,MAAM;YACT,MAAM,IAAIwB,yBAAiB,CAAC;QAC9B;QACA,MAAM,IAAI,CAAClB,YAAY,CAACmB,WAAW,CAACzB,KAAKC,EAAE,EAAEsB;QAC7C,OAAO;YAAEG,SAAS;QAA8B;IAClD;IAEA,8DAA8D;IAC9D,MAAMC,4BAA0D;QAC9D,IAAIC,QAAQC,GAAG,CAACC,cAAc,KAAK,QAAQ;YACzC,MAAM,IAAIC,0BAAkB,CAAC;QAC/B;QACA,MAAMC,WAAW,MAAM,IAAI,CAACnB,eAAe,CAACoB,OAAO;QACnD,IAAIC,UAAU;QACd,KAAK,MAAMC,KAAKH,SAAU;YACxB,IAAI,CAACG,EAAEhC,KAAK,EAAE;YACd,MAAMiC,WAAW,MAAM,IAAI,CAAC9B,YAAY,CAACC,WAAW,CAAC4B,EAAEhC,KAAK;YAC5D,IAAIiC,UAAU;YACd,MAAM,IAAI,CAAC9B,YAAY,CAAC+B,MAAM,CAAC;gBAC7BlC,OAAOgC,EAAEhC,KAAK;gBACdY,OAAO;oBAACuB,eAAI,CAACC,OAAO;iBAAC;gBACrB5B,WAAWwB,EAAElC,EAAE;YACjB;YACAiC;QACF;QACA,OAAO;YAAEA;QAAQ;IACnB;IAzFA,YACE,AAAQrB,eAAgC,EACxC,AAAQP,YAA0B,EAClC,AAAQc,UAAsB,CAC9B;aAHQP,kBAAAA;aACAP,eAAAA;aACAc,aAAAA;IACP;AAsFL"}