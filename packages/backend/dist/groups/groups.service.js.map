{"version":3,"sources":["../../src/groups/groups.service.ts"],"sourcesContent":["import { BadRequestException, Injectable } from '@nestjs/common';\nimport { InjectRepository } from '@nestjs/typeorm';\nimport { Repository } from 'typeorm';\nimport { Group } from './group.entity';\nimport { CreateGroupDto } from './dto/create-group.dto';\nimport { UpdateGroupDto } from './dto/update-group.dto';\nimport { Course } from '../courses/course.entity';\n\n@Injectable()\nexport class GroupsService {\n  constructor(\n    @InjectRepository(Group)\n    private groupRepository: Repository<Group>,\n    @InjectRepository(Course)\n    private courseRepository: Repository<Course>,\n  ) {}\n\n  private async applyCourseDefaults(dto: CreateGroupDto): Promise<CreateGroupDto> {\n    if (!dto.courseId) return dto;\n    const course = await this.courseRepository.findOne({ where: { id: dto.courseId } });\n    if (!course) {\n      throw new BadRequestException('Course not found');\n    }\n    const patched: CreateGroupDto = { ...dto };\n    if (!patched.name) patched.name = course.name;\n    if (patched.cost === undefined || patched.cost === null) patched.cost = Number(course.cost);\n    if (patched.unitCost === undefined || patched.unitCost === null) {\n      const hours = Number(course.numberOfHours);\n      const cost = Number(course.cost);\n      patched.unitCost = hours > 0 ? cost / hours : cost;\n    }\n    return patched;\n  }\n\n  async findAll(isActive?: boolean): Promise<Group[]> {\n    if (isActive !== undefined) {\n      return await this.groupRepository.find({ where: { isActive } });\n    }\n    return await this.groupRepository.find();\n  }\n\n  async findOne(id: number): Promise<Group> {\n    return await this.groupRepository.findOne({ where: { id } });\n  }\n\n  async create(createGroupDto: CreateGroupDto): Promise<Group> {\n    const patchedDto = await this.applyCourseDefaults(createGroupDto);\n    if (!patchedDto.name) throw new BadRequestException('name is required');\n    if (patchedDto.cost === undefined || patchedDto.unitCost === undefined) {\n      throw new BadRequestException('cost and unitCost are required');\n    }\n    const group = this.groupRepository.create(patchedDto);\n    return await this.groupRepository.save(group);\n  }\n\n  async update(id: number, updateGroupDto: UpdateGroupDto): Promise<Group> {\n    await this.groupRepository.update(id, updateGroupDto);\n    return await this.findOne(id);\n  }\n\n  async remove(id: number): Promise<void> {\n    await this.groupRepository.delete(id);\n  }\n\n  async batchUpsert(\n    groups: CreateGroupDto[],\n  ): Promise<{ created: number; updated: number; groups: Group[] }> {\n    const results: Group[] = [];\n    let created = 0;\n    let updated = 0;\n\n    for (const groupDto of groups) {\n      const patchedDto = await this.applyCourseDefaults(groupDto);\n      if (!patchedDto.name) throw new BadRequestException('name is required');\n      if (patchedDto.cost === undefined || patchedDto.unitCost === undefined) {\n        throw new BadRequestException('cost and unitCost are required');\n      }\n      // Find existing group by name\n      const existingGroup = await this.groupRepository.findOne({\n        where: { name: patchedDto.name },\n      });\n\n      if (existingGroup) {\n        // Update existing group\n        await this.groupRepository.update(existingGroup.id, patchedDto);\n        const updatedGroup = await this.findOne(existingGroup.id);\n        results.push(updatedGroup);\n        updated++;\n      } else {\n        // Create new group\n        const newGroup = this.groupRepository.create(patchedDto);\n        const savedGroup = await this.groupRepository.save(newGroup);\n        results.push(savedGroup);\n        created++;\n      }\n    }\n\n    return { created, updated, groups: results };\n  }\n}\n"],"names":["GroupsService","applyCourseDefaults","dto","courseId","course","courseRepository","findOne","where","id","BadRequestException","patched","name","cost","undefined","Number","unitCost","hours","numberOfHours","findAll","isActive","groupRepository","find","create","createGroupDto","patchedDto","group","save","update","updateGroupDto","remove","delete","batchUpsert","groups","results","created","updated","groupDto","existingGroup","updatedGroup","push","newGroup","savedGroup"],"mappings":"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"}