{"version":3,"sources":["../../src/users/users.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\nimport { InjectRepository } from '@nestjs/typeorm';\nimport { Repository } from 'typeorm';\nimport { User } from './user.entity';\nimport { randomBytes, scrypt as _scrypt } from 'crypto';\nimport { promisify } from 'util';\n\nconst scrypt = promisify(_scrypt);\n\n@Injectable()\nexport class UsersService {\n  constructor(\n    @InjectRepository(User)\n    private usersRepo: Repository<User>,\n  ) {}\n\n  async findByEmail(email: string): Promise<User | null> {\n    return this.usersRepo.findOne({ where: { email } });\n  }\n\n  async findById(id: number): Promise<User | null> {\n    return this.usersRepo.findOne({ where: { id } });\n  }\n\n  async findAll(): Promise<User[]> {\n    return this.usersRepo.find();\n  }\n\n  async create(params: { \n    email: string; \n    password?: string; \n    roles?: string[]; \n    teacherId?: number | null;\n    studentId?: number | null;\n  }): Promise<User> {\n    const { email, password, roles = [], teacherId = null, studentId = null } = params;\n    const passwordHash = password ? await this.hashPassword(password) : await this.hashPassword(this.generateTempPassword());\n    const user = this.usersRepo.create({ email, passwordHash, roles: roles, teacherId, studentId });\n    return this.usersRepo.save(user);\n  }\n\n  async setPassword(userId: number, newPassword: string): Promise<void> {\n    const passwordHash = await this.hashPassword(newPassword);\n    await this.usersRepo.update(userId, { passwordHash });\n  }\n\n  async update(userId: number, params: { \n    email?: string; \n    password?: string; \n    roles?: string[]; \n    teacherId?: number | null;\n    studentId?: number | null;\n  }): Promise<User> {\n    const updates: any = {};\n    if (params.email) updates.email = params.email;\n    if (params.password) updates.passwordHash = await this.hashPassword(params.password);\n    if (params.roles !== undefined) updates.roles = params.roles.map(r => r.toLowerCase());\n    if (params.teacherId !== undefined) updates.teacherId = params.teacherId;\n    if (params.studentId !== undefined) updates.studentId = params.studentId;\n    \n    await this.usersRepo.update(userId, updates);\n    return this.findById(userId);\n  }\n\n  async remove(userId: number): Promise<void> {\n    await this.usersRepo.delete(userId);\n  }\n\n  async verifyPassword(user: User, password: string): Promise<boolean> {\n    const [salt, storedHash] = user.passwordHash.split('.');\n    const hash = (await scrypt(password, salt, 32)) as Buffer;\n    return storedHash === hash.toString('hex');\n  }\n\n  private async hashPassword(password: string): Promise<string> {\n    const salt = randomBytes(8).toString('hex');\n    const hash = (await scrypt(password, salt, 32)) as Buffer;\n    return `${salt}.${hash.toString('hex')}`;\n  }\n\n  private generateTempPassword(): string {\n    return randomBytes(9).toString('base64');\n  }\n}\n"],"names":["UsersService","scrypt","promisify","_scrypt","findByEmail","email","usersRepo","findOne","where","findById","id","findAll","find","create","params","password","roles","teacherId","studentId","passwordHash","hashPassword","generateTempPassword","user","save","setPassword","userId","newPassword","update","updates","undefined","map","r","toLowerCase","remove","delete","verifyPassword","salt","storedHash","split","hash","toString","randomBytes"],"mappings":"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"}