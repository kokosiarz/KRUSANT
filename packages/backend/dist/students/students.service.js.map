{"version":3,"sources":["../../src/students/students.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\nimport { InjectRepository } from '@nestjs/typeorm';\nimport { Repository } from 'typeorm';\nimport { Student } from './student.entity';\nimport { CreateStudentDto } from './dto/create-student.dto';\nimport { UpdateStudentDto } from './dto/update-student.dto';\n\nimport { DataSource } from 'typeorm';\nimport { StudentWithBalanceDto } from './dto/student-with-balance.dto';\n\n@Injectable()\nexport class StudentsService {\n  constructor(\n    @InjectRepository(Student)\n    private studentRepository: Repository<Student>,\n    private dataSource: DataSource,\n  ) {}\n  async findAllWithBalance(active?: boolean): Promise<StudentWithBalanceDto[]> {\n    // Use a single query to aggregate debits and payments per student\n    const qb = this.dataSource.createQueryBuilder();\n    qb.select('student.id', 'id')\n      .addSelect('student.name', 'name')\n      .addSelect('student.email', 'email')\n      .addSelect('student.phone', 'phone')\n      .addSelect('student.customRate', 'customRate')\n      .addSelect('student.discount', 'discount')\n      .addSelect('student.semester', 'semester')\n      .addSelect('student.extraNotes', 'extraNotes')\n      .addSelect('student.active', 'active')\n      .addSelect('COALESCE(SUM(payment.amount), 0) - COALESCE(SUM(debit.amount), 0)', 'balance')\n      .from(Student, 'student')\n      .leftJoin('debits', 'debit', 'debit.studentId = student.id')\n      .leftJoin('payment', 'payment', 'payment.studentId = student.id');\n    if (active !== undefined) {\n      qb.where('student.active = :active', { active });\n    }\n    qb.groupBy('student.id');\n    qb.addGroupBy('student.name');\n    qb.addGroupBy('student.email');\n    qb.addGroupBy('student.phone');\n    qb.addGroupBy('student.customRate');\n    qb.addGroupBy('student.discount');\n    qb.addGroupBy('student.semester');\n    qb.addGroupBy('student.extraNotes');\n    qb.addGroupBy('student.active');\n    const result = await qb.getRawMany<StudentWithBalanceDto>();\n    return result;\n  }\n\n  async findAll(active?: boolean): Promise<Student[]> {\n    if (active !== undefined) {\n      return await this.studentRepository.find({ where: { active } });\n    }\n    return await this.studentRepository.find();\n  }\n\n  async findOne(id: number): Promise<Student> {\n    return await this.studentRepository.findOne({ where: { id } });\n  }\n\n  async findByEmail(email: string): Promise<Student> {\n    return await this.studentRepository.findOne({ where: { email } });\n  }\n\n  async create(createStudentDto: CreateStudentDto): Promise<Student> {\n    const student = this.studentRepository.create(createStudentDto);\n    return await this.studentRepository.save(student);\n  }\n\n  async update(\n    id: number,\n    updateStudentDto: UpdateStudentDto,\n  ): Promise<Student> {\n    await this.studentRepository.update(id, updateStudentDto);\n    return await this.findOne(id);\n  }\n\n  async remove(id: number): Promise<void> {\n    await this.studentRepository.delete(id);\n  }\n\n  async batchUpsert(\n    students: CreateStudentDto[],\n  ): Promise<{ created: number; updated: number; students: Student[] }> {\n    const results: Student[] = [];\n    let created = 0;\n    let updated = 0;\n\n    for (const studentDto of students) {\n      // Find existing student by email\n      const existingStudent = await this.studentRepository.findOne({\n        where: { email: studentDto.email },\n      });\n\n      if (existingStudent) {\n        // Update existing student\n        await this.studentRepository.update(existingStudent.id, studentDto);\n        const updatedStudent = await this.findOne(existingStudent.id);\n        results.push(updatedStudent);\n        updated++;\n      } else {\n        // Create new student\n        const newStudent = this.studentRepository.create(studentDto);\n        const savedStudent = await this.studentRepository.save(newStudent);\n        results.push(savedStudent);\n        created++;\n      }\n    }\n\n    return { created, updated, students: results };\n  }\n}\n"],"names":["StudentsService","findAllWithBalance","active","qb","dataSource","createQueryBuilder","select","addSelect","from","Student","leftJoin","undefined","where","groupBy","addGroupBy","result","getRawMany","findAll","studentRepository","find","findOne","id","findByEmail","email","create","createStudentDto","student","save","update","updateStudentDto","remove","delete","batchUpsert","students","results","created","updated","studentDto","existingStudent","updatedStudent","push","newStudent","savedStudent"],"mappings":"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"}